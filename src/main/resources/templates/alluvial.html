<!-- HTML5 document type -->
 <html lang="en" xmlns="http://www.w3.org/1999/xhtml" 
    xmlns:th="http://www.thymeleaf.org" 
    xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
<meta charset="utf-8"/>
<meta name="diffvalue" th:content="${diffvalue}"></meta>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
 
<title>Alluvial Diagram </title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/github.min.css" />
<link rel="stylesheet" href="Treant.css" type="text/css"/>
<link rel="stylesheet" href="custom-colored.css" type="text/css"/>
<link rel="stylesheet" type="text/css" href="dist/diff2html.css" />
<link rel="stylesheet" type="text/css" href="/dist/diff2html.css" />
<link rel="stylesheet" href="styles/kendo.common.min.css" />
<link rel="stylesheet" href="styles/kendo.default.min.css" />
<link rel="stylesheet" href="styles/kendo.default.mobile.min.css" />
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css"/>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous" />


<script src="NavigationMap.js"></script>
<script src="js/jquery.min.js"></script>
<script src="js/kendo.all.min.js"></script>
<script type="text/javascript" src="dist/diff2html.js"></script>
<script type="text/javascript" src="dist/diff2html-ui.js"></script>
<script src="vendor/raphael.js"></script>
<script src="Treant.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>

<style>
.node rect {
  cursor: move;
  fill-opacity: .9;
  shape-rendering: crispEdges;
}
.node text {
  pointer-events: none;
  text-shadow: 0 1px 0 #fff;
}
.link {
  fill: none;
  stroke: #000;
  stroke-opacity: .2;
}
.link:hover {
  stroke-opacity: .5;
}
#treeview .k-sprite {
            background-image: url("../content/web/treeview/coloricons-sprite.png");
        }

        .rootfolder { background-position: 0 0; }
        .folder     { background-position: 0 -16px; }
        .pdf        { background-position: 0 -32px; }
        .html       { background-position: 0 -48px; }
        .image      { background-position: 0 -64px; }

   #example {
        min-height: 200px;
    }

        #example .title {
            font-weight: bold;
            margin-bottom: 25px;
        }

    .search-wrapper {
        width: 100%;
    }
    .query-match {
        color: red;
    }
    .select-all-wrapper {
        margin-top: 20px;
        margin-bottom: 20px;
    }

    .selected-count {
        float: right;
        color: #aaa;
    }
    .k-treeview {
        border-width: 1px!important;
        padding: 5px;
    }
    .selectedName {
        padding: 5px 10px;
        background: #aaa;
        color: white;
        float: left;
        margin-right: 5px;
        margin-bottom: 5px;
        border-radius: 10px;
    }

    #result {
        padding-bottom: 15px;
    }

        #result:after {
            content: '';
            display: block;
            clear: both;
        }

html,body,h1,h2,h3,h4,h5 {font-family: "Raleway", sans-serif}
</style>
</head>


<!-- Header-->
<body align="center" >
<div align="left" style="z-index:4">
<span align="left">
	<img src="customDiffLargo.png" alt="Logo" style="width:320px;height:90px;"/>
</span>
<p style="font-size:200%;">Tracing product customizations in SPLs</p>
</div>

<!-- Table -->
<table  class="table table-bordered table-striped table-responsive " cellpadding="100" style="background-color:#E8E8E8;width:98%">

	<tr><!-- Navigation map on left hand-side -->
        <td style="width:20%" align="center">
			<p style= "color:#ff6200; font-size: 180%;" align="center"> Navigation map</p>
			<div id="tree-simple" style="font-size:300%; width:600px; height: 300px"> Navigation Map</div>
			<script><!-- Script for the drawing of the navigation map-->
				var my_chart = new Treant(simple_chart_config);	//loaded from Navigation map js
			</script>
		</td>
		<!--Diagram view -->
		<td valign="botton" style="width:70%" align="center">
			<p style= "color:#ff6200; font-size: 180%;" align="center"> What features have been customized? </p>
			<p style="font-size:100%;" align="center"> 
			Note: Streams' height denotes customization change-size per Feature-Product pair.
			<br/>Rectangles area denotes customization change-size per Feature/Product.
			</p>
			<div id="chart" align="center"/>
		
		</td>
	</tr>
</table>


<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="sankey.js"></script>
<script src="draw.js"></script>
 <script> <!-- Script for drawing the alluvial diagram -->
//<![CDATA[
  var units = "Widgets";
	var margin = {top: 10, right: 10, bottom: 10, left: 10},
	    width = 900 - margin.left - margin.right,
	    height = 700 - margin.top - margin.bottom;
	var formatNumber = d3.format(",.0f"),    // zero decimal places
	    format = function(d) { return formatNumber(d) + " " + units; },
	    color = d3.scale.category20();
	// append the svg canvas to the page
	var svg = d3.select("#chart").append("svg")
	    .attr("width", width + margin.left + margin.right)
	    .attr("height", height + margin.top + margin.bottom)
	  .append("g")
	    .attr("transform", 
	          "translate(" + margin.left + "," + margin.top + ")");
	// Set the sankey diagram properties
	var sankey = d3.sankey()
	    .nodeWidth(36)
	    .nodePadding(40)
	    .size([width, height]);
	var path = sankey.link();
	// load the data (using the timelyportfolio csv method)
	d3.csv("/alluvial.csv", function(error, data) {
	  //set up graph in same style as original example but empty
	  graph = {"nodes" : [], "links" : []};
	    data.forEach(function (d) {
	      graph.nodes.push({ "name": d.source });
	      graph.nodes.push({ "name": d.target });
	      graph.links.push({ "source": d.source,
	                         "target": d.target,
	                         "value": +d.value });
	     });
	     // return only the distinct / unique nodes
	     graph.nodes = d3.keys(d3.nest()
	       .key(function (d) { return d.name; })
	       .map(graph.nodes));
	     // loop through each link replacing the text with its index from node
	     graph.links.forEach(function (d, i) {
	       graph.links[i].source = graph.nodes.indexOf(graph.links[i].source);
	       graph.links[i].target = graph.nodes.indexOf(graph.links[i].target);
	     });
	     //now loop through each nodes to make nodes an array of objects
	     // rather than an array of strings
	     graph.nodes.forEach(function (d, i) {
	       graph.nodes[i] = { "name": d };
	     });
	  sankey
	    .nodes(graph.nodes)
	    .links(graph.links)
	    .layout(32);
	// add in the links
	  var link = svg.append("g").selectAll(".link")
	      .data(graph.links)
	    .enter().append("path")
	      .attr("class", "link")
	      .attr("d", path)
	      .style("stroke-width", function(d) { return Math.max(1, d.dy); })
	      .sort(function(a, b) { return b.dy - a.dy; })
	      .on("click",function(d, a , b,link){
        if (d3.event.defaultPrevented) return;
           goToFeatureViewDetailed(d);
    		});
	// add the link titles
	  link.append("title")
	        .text(function(d) {
	        	var show = "diff("+d.source.name+", "+d.target.name+")";
	        	//d.source.name + " â†’ " +  d.target.name + "\n" + format(d.value);
	    		return show;});
	// add in the nodes
	  var node = svg.append("g").selectAll(".node")
	      .data(graph.nodes)
	    .enter().append("g")
	      .attr("class", "node")
	      .attr("transform", function(d) { 
			  return "translate(" + d.x + "," + d.y + ")"; })
			   .on("click",function(d){
        if (d3.event.defaultPrevented) return;
           window.console.log("clicked on product:"+d.name);
          
           if (d.name.includes("Product") || d.name.includes("product"))
        	     goToReuseLevelView(d);//goToReuseLevelView
           else goToFeatureView (d);
    		});
	  /*  .call(d3.behavior.drag()
	      .origin(function(d) { return d; })
	      .on("dragstart", function() { 
			  this.parentNode.appendChild(this); })
	      .on("drag", dragmove));*/
	      

		
	// add the rectangles for the nodes
	  node.append("rect")
	  .attr("height", function(d) { return d.dy; })
	      .attr("width", sankey.nodeWidth())
	      .attr("text", "asdasdadaa")
	      .style("fill", function(d) { 
			  return d.color = color(d.name.replace(/ .*/, "")); })
	      .style("stroke", function(d) { return d3.rgb(d.color).darker(2); })
		  .on("mouseover", myMouseoverFunction)
		.on("mouseout", myMouseoutFunction)
	    .append("title").text(function(d) { 
	    		var show;
	    	     if(d.name.includes("product")) 
	    	    	 	show="diff(Baseline-v1.0,"+ d.name+")";
	    	     else show="diff("+ d.name+", product portfolio)";
	    	    	 //d.name + "\n" + format(d.value);
			  return show;
			  });
	
	        
	      // add in the title for the nodes
	
	
	
	node.append("text")
	      .attr("x", -6)
	      .attr("y", function(d) { return d.dy / 2; })
	      .attr("dy", ".35em")
	      .attr("text-anchor", "end")
	      .attr("transform", null)
	      .text(function(d) { return d.name; })
	   	    .filter(function(d) { return d.x < width / 2; })
	      .attr("x", 6 + sankey.nodeWidth())
	      .attr("text-anchor", "start");

	// the function for moving the nodes
	  function dragmove(d) {
	    d3.select(this).attr("transform", 
	        "translate(" + d.x + "," + (
	                d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))
	            ) + ")");
	    sankey.relayout();
	    link.attr("d", path);
	  }
	function goToReuseLevelView(d){
		window.location.href = "http://localhost:8080/reuseLevelView?zoom=true&pr=" + d.name;
	}

	function goToFeatureView(d){
	    window.location.href = "http://localhost:8080/treemapLightsView?base=Baseline-v1.0&fname=" + d.name+"&idfile=0";
	}
	function goToFeatureViewDetailed(d){
		console.log(d);
		 window.location.href = "http://localhost:8080/treemapfeatureproductview?base=Baseline-v1.0&fname=" + d.source.name+"&pr="+d.target.name+"&idfile=0";
	}
	

	function goToVPsView(link){
		 window.location.href = "http://localhost:8080/product_structure?pr="+link.target.name+"&file=0";//" + d.source.name+"-v1.0"; 
	}
	
	
	function myMouseoverFunction(d){
	    window.console.log(this);
	    window.console.log(d);
		//d3.select(this).style("fill","white");
		
		d3.select(this)
		  .attr("height", function(d) { return d.dy + 20; })
	      .attr("width", sankey.nodeWidth() +15);
	}
  function myMouseoutFunction(d) {
	  d3.select(this).style("fill", function(d) { 
		  return d.color = color(d.name.replace(/ .*/, "")); })
      .style("stroke", function(d) { 
		  return d3.rgb(d.color).darker(5); });
	  
	  d3.select(this)
	  .attr("height", function(d) { return d.dy; })
      .attr("width", sankey.nodeWidth());
  
  }
        
	});//end
	//]]>

</script>


<script>
<!-- Script for the filtering menu -->
//<![CDATA[
		
$(document).ready(function () {
			
		var node = document.getElementsByClassName("node nodeExample1 orange");
		
		var dialogdiv = document.createElement("div");
		dialogdiv.setAttribute("id","dialog");
		
		var button = document.createElement("button");
		var t = document.createTextNode("Filter");    
		button.appendChild(t);            
		button.setAttribute("id","pickEmployeesButton");  
		//button.setAttribute("class","k-primary");
		
		node[0].appendChild(dialogdiv);
		node[0].appendChild(button);
	
			 var tempSelectList = [];
		     var dialog = $("#dialog").kendoDialog({
		            width: "400px",
		            height: "500px",
		            visible: false,
		            title: "Features",
		            closable: true,
		            modal: false,
		            content: "<div class='k-textbox k-space-right search-wrapper'><input id='employees-search' type='text'  placeholder='Search feature'/><span class='k-icon k-i-search'></span></div>" +             
		                "<div class='select-all-wrapper'><input data-role='checkbox' onchange='selectAll(this)' type='checkbox' class='k-checkbox' id='_selectAllEmployees'/><label class='k-checkbox-label' for='_selectAllEmployees'>Select all features</label><span class='selected-count'></span></div>" +
		                "<div id='treeview'></div>",
		            actions: [
		                { text: 'Cancel'},
		                { text: 'OK', primary: true, action: actionOK }
		            ],
		            initOpen: initOpen,
		            open: dialogOpen
		        });

		        $("#pickEmployeesButton").kendoButton({
		            click: openDialog
		        });
		       


      
        var featuremodel = [{
            id: "WeatherStation", FullName: "WeatherStation", expanded: true,hasChildren:true, spriteCssClass: "rootfolder", items: [
                {
                    id: "Sensors", FullName: "Sensors", expanded: false, hasChildren:true, spriteCssClass: "man", items: [
                        { id: "Temperature", FullName: "Temperature", spriteCssClass: "or", hasChildren:false },
                        { id: "WindSpeed", FullName: "WindSpeed", spriteCssClass: "or" , hasChildren:false },
                        { id: "AirPressure", FullName: "AirPressure", spriteCssClass: "or", hasChildren:false }
                    ]
                },
                {
                    id: "Languages", FullName: "Languages", expanded: false, hasChildren:true,spriteCssClass: "man", items: [
                        { id: "English", FullName: "English", spriteCssClass: "alt", hasChildren:false },
                        { id: "German", FullName: "German", spriteCssClass: "alt", hasChildren:false },
                    ]
                },
                {
                    id: "Warnings", FullName: "Warnings", expanded: false,hasChildren:true, spriteCssClass: "optional", items: [
                        { id: "Gale", FullName: "Gale", spriteCssClass: "or" , hasChildren:false},
                        { id: "Heat", FullName: "Heat", spriteCssClass: "or" , hasChildren:false},
                    ]
                }
            ]
        }];

        $("#treeview").kendoTreeView({
            	dataSource:featuremodel,
            	autoScroll: false,
            dataTextField: "FullName",
            checkboxes: true,
            checkboxes: {
                checkChildren: true
              },
            loadOnDemand: true,
            expandAll: true,
            dataBound: treeViewDataBound,
            check: treeViewCheck
        });
        
    });//end of on document load

    function treeViewDataBound(e) {
        e.sender.expand(e.node);
    }

    function initOpen(e) {
        $("#employees-search").on("input", function () {
            var query = this.value.toLowerCase();
            var dataSource = $("#treeview").data("kendoTreeView").dataSource;
            filter(dataSource, query);
            matchColors(query);
        });
    }

    function dialogOpen(e) {
        var treeView = $("#treeview").data("kendoTreeView");
        tempSelectList = getCheckedItems(treeView);
        setTimeout(function () {
            $("#employees-search").focus().select();
        })
    }
    function openDialog() {
    		console.log($("#dialog"));
	    	console.log($("#dialog").data("kendoDialog"));
	        
	    	$("#dialog").data("kendoDialog").open();
	  }

    function actionOK(e) {
        var treeView = $("#treeview").data("kendoTreeView");
        var checkedNodes = getCheckedItems(treeView);
        updateResult(checkedNodes);
        var filter = getCheckedItemsList(treeView); 
        window.location.href = "http://localhost:8080/alluvialView?idbaseline=Baseline-v1.0&id_product_asset=0&filter="+filter;//" + d.source.name+"-v1.0";
    }
    
	  function removeFeatureFilter(){//removeFilter()
		  window.location.href = "http://localhost:8080/alluvialView?idbaseline=Baseline-v1.0&id_product_asset=0";//" + d.source.name+"-v1.0";
	    }
    
    
    function updateResult(checkedNodes) {
        if (checkedNodes.length > 0) {
            var result = "";
            for (var i = 0; i < checkedNodes.length; i++) {
                result += "<span class='selectedName'>" + checkedNodes[i].FullName + "</span>";
            }
        } else {
            result = "No feature selected.";
        }

        $("#result").html(result);
        
    }
    function treeViewCheck(e) {
        setTimeout(function () {
            updateSelectedCount(e.sender);
        })
    }

    function selectAll(sender) {
        $("#treeview .k-checkbox").removeAttr("checked").prop("checked", sender.checked);
        $("#treeview .k-checkbox").trigger("change");
    }

    function updateSelectedCount(treeView) {
        $(".selected-count").html(getCheckedItems(treeView).length + " Features selected");
    }
    
    function getCheckedItems(treeview) {
        var nodes = treeview.dataSource.view();
        return getCheckedNodes(nodes);
    }
    
    
    function getCheckedItemsList(treeview){
    	   var nodes = treeview.dataSource.view();
    	   var checkedNodes = [],   message="null";

       checkedNodeIds(treeview.dataSource.view(), checkedNodes);
       if (checkedNodes.length > 0) {
           message = checkedNodes.join(",");
       } 
       console.log("Message:" +message);
       return message;
    }

    function getCheckedNodes(nodes) {
        var node, childCheckedNodes;
        var checkedNodes = [];

        for (var i = 0; i < nodes.length; i++) {
            node = nodes[i];
            if (node.checked) {
                checkedNodes.push(node);
            }

            if (node.hasChildren) {
                childCheckedNodes = getCheckedNodes(node.children.view());
                if (childCheckedNodes.length > 0) {
                    checkedNodes = checkedNodes.concat(childCheckedNodes);
                }
            }
        }

        return checkedNodes;
    }

    function filter(dataSource, query) {
        var hasVisibleChildren = false;
        var data = dataSource instanceof kendo.data.HierarchicalDataSource && dataSource.data();

        for (var i = 0; i < data.length; i++) {
            var item = data[i];            
            var text = item.FullName.toLowerCase();
            var itemVisible =
                query === true // parent already matches
                || query === "" // query is empty
                || text.indexOf(query) >= 0; // item text matches query

            var anyVisibleChildren = filter(item.children, itemVisible || query); // pass true if parent matches

            hasVisibleChildren = hasVisibleChildren || anyVisibleChildren || itemVisible;

            item.hidden = !itemVisible && !anyVisibleChildren;
        }

        if (data) {
            // re-apply filter on children
            dataSource.filter({ field: "hidden", operator: "neq", value: true });
        }

        return hasVisibleChildren;
    }

  
    
    function matchColors(query, element) {
        $("#treeview .k-in:containsIgnoreCase('" + query + "')").each(function () {
            var index = $(this).html().toLowerCase().indexOf(query.toLowerCase());
            var length = query.length;
            var original = $(this).html().substr(index, length);
            var newText = $(this).html().replace(original, "<span class='query-match'>" + original + "</span>");
            $(this).html(newText);
        });
    }

    $.expr[':'].containsIgnoreCase = function (n, i, m) {
        return jQuery(n).text().toUpperCase().indexOf(m[3].toUpperCase()) >= 0;
    };
    
 
    
  //]]>
</script>



 <script>
    //this is the old script
  //<![CDATA[
        $("#treeview").kendoTreeView({
            checkboxes: {
                checkChildren: true
            },
            check: onCheck,

            dataSource: [{
                id: "WeatherStation", text: "Weather Station", expanded: true, spriteCssClass: "rootfolder", items: [
                    {
                        id: "Sensors", text: "Sensors", expanded: false, spriteCssClass: "man", items: [
                            { id: "Temperature", text: "Temperature", spriteCssClass: "or" },
                            { id: "WindSpeed", text: "Wind Speed", spriteCssClass: "or" },
                            { id: "AirPressure", text: "Air Pressure", spriteCssClass: "or" }
                        ]
                    },
                    {
                        id: "Languages", text: "Languages", expanded: false, spriteCssClass: "man", items: [
                            { id: "English", text: "English", spriteCssClass: "alt" },
                            { id: "German", text: "German", spriteCssClass: "alt" },
                        ]
                    },
                    {
                        id: "Warnings", text: "Warnings", expanded: false, spriteCssClass: "optional", items: [
                            { id: "Gale", text: "Gale", spriteCssClass: "or" },
                            { id: "Heat", text: "Heat", spriteCssClass: "or" },
                        ]
                    }
                ]
            }]
        });

        // function that gathers IDs of checked nodes
        function checkedNodeIds(nodes, checkedNodes) {
            for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].checked) {
                    checkedNodes.push(nodes[i].id);
                }

                if (nodes[i].hasChildren) {
                    checkedNodeIds(nodes[i].children.view(), checkedNodes);
                }
            }
        }

        // show checked node IDs on datasource change
        
        function filterByFeature(){
	        	 var checkedNodes = [],
	             treeView = $("#treeview").data("kendoTreeView"),
	             message="null";
	
	         checkedNodeIds(treeView.dataSource.view(), checkedNodes);
	
	         if (checkedNodes.length > 0) {
	             message = checkedNodes.join(",");
	         } 
	         //go and filter by feature Name
	         window.location.href = "http://localhost:8080/alluvialView?idbaseline=Baseline-v1.0&id_product_asset=0&filter="+message;//" + d.source.name+"-v1.0";
	        
         }


        function onCheck() {
            var checkedNodes = [],
                treeView = $("#treeview").data("kendoTreeView"),
                message;

            checkedNodeIds(treeView.dataSource.view(), checkedNodes);

            if (checkedNodes.length > 0) {
                message = "Selected features: " + checkedNodes.join(",");
            } else {
                message = "No feature selected.";
            }

            $("#result").html(message);
           
            //go and filter by feature Name
           // window.location.href = "http://localhost:8080/alluvialView?idbaseline=Baseline-v1.0&id_product_asset=0&filter"+message;//" + d.source.name+"-v1.0";
        }
        
   
        //]]>
    </script>
    

</body>
</html>